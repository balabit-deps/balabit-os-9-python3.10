Backport of:

From 23e3c0ae867cca0130e441e776c9955b9027c510 Mon Sep 17 00:00:00 2001
From: "Miss Islington (bot)"
 <31488909+miss-islington@users.noreply.github.com>
Date: Sat, 17 Jan 2026 19:11:52 +0100
Subject: [PATCH] [3.14] gh-143916: Reject control characters in
 wsgiref.headers.Headers  (GH-143917) (#143972)

gh-143916: Reject control characters in wsgiref.headers.Headers  (GH-143917)

* Add 'test.support' fixture for C0 control characters
* gh-143916: Reject control characters in wsgiref.headers.Headers
(cherry picked from commit f7fceed79ca1bceae8dbe5ba5bc8928564da7211)

Co-authored-by: Seth Michael Larson <seth@python.org>
---
 Lib/test/support/__init__.py                         |  7 +++++++
 Lib/test/test_wsgiref.py                             | 12 +++++++++++-
 Lib/wsgiref/headers.py                               |  3 +++
 .../2026-01-16-11-07-36.gh-issue-143916.dpWeOD.rst   |  2 ++
 4 files changed, 23 insertions(+), 1 deletion(-)
 create mode 100644 Misc/NEWS.d/next/Security/2026-01-16-11-07-36.gh-issue-143916.dpWeOD.rst

--- python3.10-3.10.12.orig/Lib/test/support/__init__.py
+++ python3.10-3.10.12/Lib/test/support/__init__.py
@@ -2122,3 +2122,10 @@ def adjust_int_max_str_digits(max_digits
         yield
     finally:
         sys.set_int_max_str_digits(current)
+
+
+def control_characters_c0() -> list[str]:
+    """Returns a list of C0 control characters as strings.
+    C0 control characters defined as the byte range 0x00-0x1F, and 0x7F.
+    """
+    return [chr(c) for c in range(0x00, 0x20)] + ["\x7F"]
--- python3.10-3.10.12.orig/Lib/test/test_wsgiref.py
+++ python3.10-3.10.12/Lib/test/test_wsgiref.py
@@ -1,6 +1,6 @@
 from unittest import mock
 from test import support
-from test.support import socket_helper
+from test.support import socket_helper, control_characters_c0
 from test.support import warnings_helper
 from test.test_httpservers import NoLogRequestHandler
 from unittest import TestCase
@@ -527,6 +527,16 @@ class HeaderTests(TestCase):
             '\r\n'
         )
 
+    def testRaisesControlCharacters(self):
+        headers = Headers()
+        for c0 in control_characters_c0():
+            self.assertRaises(ValueError, headers.__setitem__, f"key{c0}", "val")
+            self.assertRaises(ValueError, headers.__setitem__, "key", f"val{c0}")
+            self.assertRaises(ValueError, headers.add_header, f"key{c0}", "val", param="param")
+            self.assertRaises(ValueError, headers.add_header, "key", f"val{c0}", param="param")
+            self.assertRaises(ValueError, headers.add_header, "key", "val", param=f"param{c0}")
+
+
 class ErrorHandler(BaseCGIHandler):
     """Simple handler subclass for testing BaseHandler"""
 
--- python3.10-3.10.12.orig/Lib/wsgiref/headers.py
+++ python3.10-3.10.12/Lib/wsgiref/headers.py
@@ -9,6 +9,7 @@ written by Barry Warsaw.
 # existence of which force quoting of the parameter value.
 import re
 tspecials = re.compile(r'[ \(\)<>@,;:\\"/\[\]\?=]')
+_control_chars_re = re.compile(r'[\x00-\x1F\x7F]')
 
 def _formatparam(param, value=None, quote=1):
     """Convenience function to format and return a key=value pair.
@@ -41,6 +42,8 @@ class Headers:
     def _convert_string_type(self, value):
         """Convert/check value type."""
         if type(value) is str:
+            if _control_chars_re.search(value):
+                raise ValueError("Control characters not allowed in headers")
             return value
         raise AssertionError("Header names/values must be"
             " of type str (got {0})".format(repr(value)))
